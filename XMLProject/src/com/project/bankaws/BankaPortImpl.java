
/**
 * Please modify this class to meet your needs
 * This class is not complete
 */

package com.project.bankaws;

import java.io.File;
import java.io.FileOutputStream;
import java.io.OutputStream;
import java.math.BigDecimal;
import java.net.MalformedURLException;
import java.net.URL;
import java.util.ArrayList;
import java.util.List;
import java.util.ResourceBundle;
import java.util.logging.Logger;

import javax.ejb.Stateless;
import javax.jws.HandlerChain;
import javax.xml.XMLConstants;
import javax.xml.bind.JAXBContext;
import javax.xml.bind.Marshaller;
import javax.xml.datatype.DatatypeConfigurationException;
import javax.xml.namespace.QName;
import javax.xml.transform.Source;
import javax.xml.transform.stream.StreamSource;
import javax.xml.validation.Schema;
import javax.xml.validation.SchemaFactory;
import javax.xml.validation.Validator;
import javax.xml.ws.Binding;
import javax.xml.ws.BindingProvider;
import javax.xml.ws.Service;
import javax.xml.ws.handler.Handler;

import misc.RESTUtil;

import org.apache.commons.io.IOUtils;

import com.project.banke_racuni.RacuniBanaka;
import com.project.banke_racuni.RacuniBanaka.KodBanke;
import com.project.common_types.TBankarskiRacunKlijenta;
import com.project.common_types.TRacunKlijenta;
import com.project.document.handler.WSCryptoHandler;
import com.project.document.handler.WSSignatureHandler;
import com.project.exceptions.NoMoneyException;
import com.project.exceptions.WrongBankException;
import com.project.mt102.Mt102;
import com.project.mt103.Mt103;
import com.project.mt900.Mt900Clearing;
import com.project.mt900.Mt900RTGS;
import com.project.mt910.Mt910;
import com.project.nalog_za_placanje.NalogZaPlacanje;
import com.project.nalog_za_placanje.Placanje;
import com.project.nalog_za_placanje.Uplata;
import com.project.racuni.Racuni;
import com.project.stavka_preseka.Transakcija;
import com.project.transakcije.Transakcije;
import com.project.util.CBport;
import com.project.util.Util;
import com.project.zahtev_za_izvod.ZahtevZaIzvod;

/**
 * This class was generated by Apache CXF 2.6.5
 * 2015-06-07T02:41:04.821+02:00
 * Generated source version: 2.6.5
 * 
 */
@Stateless

@javax.jws.WebService(
                      serviceName = "BankaService",
                      portName = "BankaPort",
                      targetNamespace = "http://www.project.com/BankaWS",
                      wsdlLocation = "WEB-INF/wsdl/Banka.wsdl",
                      endpointInterface = "com.project.bankaws.BankaPort")
@HandlerChain(file = "/com/project/document/handler-chain-document.xml")
public class BankaPortImpl implements BankaPort {

    private static final Logger LOG = Logger.getLogger(BankaPortImpl.class.getName());
    
    /* (non-Javadoc)
     * @see com.project.bankaws.BankaPort#odradiClearing(*
     */
    public com.project.common_types.Status odradiClearing() throws ClearingFault {
        	com.project.common_types.Status _return = new com.project.common_types.Status();
            ArrayList<Mt102> nalozi = PortHelper.current_bank.formirajClearingNalog();
            
			try {
				URL wsdl = new URL("http://localhost:8080/projCB/services/Banka?wsdl");
		    	QName serviceName = new QName("http://www.project.com/CBws", "CBservice");
		    	QName portName = new QName("http://www.project.com/CBws", "CBport");
		    	Service service = Service.create(wsdl, serviceName);
		        CBport centralnaBanka = service.getPort(portName, CBport.class);
		        //Za svaku banku pojedinacno poslati naloge za kliring
		        for(Mt102 m: nalozi){
	    	        try {
	    	        	///////////////////////// DEO ZA KLIJENTSKI HANDLER ///////////////////////////
	    	        	/////                                                                    //////
	    			          Binding binding = ((BindingProvider)centralnaBanka).getBinding();
	    			          @SuppressWarnings("rawtypes")
	    			          List<Handler> handlerList = binding.getHandlerChain();
	    			          handlerList.clear();
	    			          handlerList.add(new WSSignatureHandler());
	    			          handlerList.add(new WSCryptoHandler());
	    			          binding.setHandlerChain(handlerList);  
	    	        	/////                                                                    //////
	    			    ///////////////////////////////////////////////////////////////////////////////
    			          
						Mt900Clearing response = centralnaBanka.receiveMT102CB(m);
						RESTUtil.objectToDB("Banka/00"+PortHelper.current_bank.getId()+"/MT900clearing", response.getIDPoruke(), response);
					} catch (com.project.util.ReceiveMT102Fault e) {
						e.printStackTrace();
						//Ako se desila greska pri kliringu, npr. neispravan ukupan iznos ili pogresan swift kod.
						//Revertovati svaki nalog posebno (vratiti raspoloziva sredstva na staru vrednost)
						for(Placanje p: m.getPlacanje()){
							TBankarskiRacunKlijenta racun_duznika = PortHelper.current_bank.getSpecificAccount(p.getUplata().getRacunDuznika().getBrojRacuna());
							racun_duznika.setRaspolozivaSredstva(racun_duznika.getRaspolozivaSredstva()+p.getUplata().getIznos().doubleValue());
							//Update stanja racuna u bazi
							Racuni rac1 = new Racuni();
			    			//Spustamo izmenjena stanja na racunima u bazu
			    			rac1 = (Racuni) RESTUtil.doUnmarshall("//Racuni", "Banka/00"+PortHelper.current_bank.getId(), rac1);
			    			//Ovde uraditi update stanja na racunima, pa baciti u bazu ponovo
			    			for(TBankarskiRacunKlijenta k: rac1.getRacun()){
			    				//Nasli smo koji je racun u pitanju
			    				if(k.getRacun().getBrojRacuna().equals(racun_duznika.getRacun().getBrojRacuna())){
			    					//dodajemo mu novac
			    					k.setRaspolozivaSredstva(racun_duznika.getRaspolozivaSredstva());
			    					break;
			    				}
			    			}
			    			//vracamo u bazu izmenjena raspoloziva sredstva
			    			RESTUtil.doMarshall("Banka/00"+PortHelper.current_bank.getId()+"/Racuni", rac1);
						}
						throw new ClearingFault("An error occured with the clearing "+m.getIDPoruke()+"\nReason: "+
						e.getMessage());
					}
	            }
		        _return.setStatusText("All clearings have been processed.");
			} catch (MalformedURLException e) {
				e.printStackTrace();
				throw new ClearingFault("Wsdl url not valid.");
			} catch(Exception ex){
				ex.printStackTrace();
				throw new ClearingFault(ex.getMessage());
			}
            return _return;
        //throw new ClearingFault("clearingFault...");
    }

    /* (non-Javadoc)
     * @see com.project.bankaws.BankaPort#receiveMT910(com.project.mt910.Mt910  mt910 )*
     */
    public com.project.common_types.Status receiveMT910(com.project.mt910.Mt910 mt910) throws ReceiveMT103Fault    { 
        LOG.info("Executing operation receiveMT910");
        System.out.println(mt910);
        if(!checkMt910(mt910)){
        	throw new ReceiveMT103Fault("Sent message of type MT910 was not well formed.");
        }
        com.project.common_types.Status _return = new com.project.common_types.Status();
        try {
			RESTUtil.objectToDB("Banka/00"+PortHelper.current_bank.getId()+"/MT910", mt910.getIDPoruke(), mt910);
			//Update stanja na racunu klijenta na osnovu odobrenja
			//Izvlacim iz baze mt103 nalog na osnovu polja u mt910
			Mt103 temp = new Mt103();
			temp = (Mt103) RESTUtil.doUnmarshall("//*:mt103", 
					"Banka/00"+PortHelper.current_bank.getId()+"/MT103/"+mt910.getPodaciOOdobrenju().getIDPorukeNaloga(), temp);
			//Update-ujem racun
			Racuni rac1 = new Racuni();
			//Ucitavamo racune iz baze, kako bi update-ovali podatke
			rac1 = (Racuni) RESTUtil.doUnmarshall("//Racuni", "Banka/00"+PortHelper.current_bank.getId(), rac1);
			
			TBankarskiRacunKlijenta racun_primaoca = PortHelper.current_bank.getSpecificAccount(temp.getUplata().getRacunPrimaoca().getBrojRacuna());
			if(racun_primaoca == null){
				_return.setStatusText("Client account does not exist.");
				throw new ReceiveMT103Fault(_return.getStatusText());
			}
			Transakcija transakcija = null;
			
			Transakcije wrappedResults = new Transakcije();
			wrappedResults = (Transakcije) RESTUtil.doUnmarshallTransactions("//Transakcije", "Banka/00"+PortHelper.current_bank.getId()+"/Racuni/"+racun_primaoca.getRacun().getId(), wrappedResults);
			
			transakcija = PortHelper.current_bank.generisiTransakcijuUplate(temp);
			transakcija.setStanjePreTransakcije(new BigDecimal(racun_primaoca.getStanje()));
			racun_primaoca.setStanje(racun_primaoca.getStanje()+temp.getUplata().getIznos().doubleValue());
			racun_primaoca.setRaspolozivaSredstva(racun_primaoca.getRaspolozivaSredstva()+temp.getUplata().getIznos().doubleValue());
			transakcija.setStanjePosleTransakcije(new BigDecimal(racun_primaoca.getStanje()));
			wrappedResults.getTransakcija().add(transakcija);
			RESTUtil.objectToDB("Banka/00"+PortHelper.current_bank.getId()+"/Racuni/"+racun_primaoca.getRacun().getId(), "Transakcije", wrappedResults);
			for(TBankarskiRacunKlijenta k: rac1.getRacun()){
				//Nasli smo koji je racun u pitanju
				if(k.getRacun().getBrojRacuna().equals(temp.getUplata().getRacunPrimaoca().getBrojRacuna())){
					//dodajemo mu novac
					k.setRaspolozivaSredstva(racun_primaoca.getRaspolozivaSredstva());
					k.setStanje(racun_primaoca.getStanje());
					break;
				}
			}
			//Vracam novo stanje racuna u bazu
			RESTUtil.doMarshall("Banka/00"+PortHelper.current_bank.getId()+"/Racuni", rac1);
			_return.setStatusText("Account updated.");
            return _return;
        } catch (java.lang.Exception ex) {
            ex.printStackTrace();
            throw new ReceiveMT103Fault(_return.getStatusText()+" Reason: "+ex.getMessage());
        }
        //throw new ReceiveMT103Fault("receiveMT103fault...");
    }

	/* (non-Javadoc)
     * @see com.project.bankaws.BankaPort#receiveMT102(com.project.mt102.Mt102  mt102 )*
     */
    public com.project.common_types.Status receiveMT102(com.project.mt102.Mt102 mt102) throws ReceiveMT102Fault    { 
        LOG.info("Executing operation receiveMT102");
        if(!checkMt102(mt102)){
        	throw new ReceiveMT102Fault("Sent message of type MT102 was not well formed.");
        }
        try {
        	System.out.println(PortHelper.current_bank.getAccounts().size());
        	System.out.println(PortHelper.current_bank.getId());
			RESTUtil.objectToDB("Banka/00"+PortHelper.current_bank.getId()+"/MT102", mt102.getIDPoruke(), mt102);
			
        	PortHelper.current_bank.obradiClearingNalog(mt102);
	        System.out.println(mt102);
	        com.project.common_types.Status _return = new com.project.common_types.Status();
	        _return.setStatusText("Clearing proccessed.");
	        return _return;
        } catch (java.lang.Exception ex) {
            ex.printStackTrace();
            throw new ReceiveMT102Fault("An error occured while processing clearing notice.\nReason: "+
            ex.getMessage());
        }
        //throw new ReceiveMT102Fault("receiveMT102fault...");
    }

	/* (non-Javadoc)
     * @see com.project.bankaws.BankaPort#sendPresek(com.project.zahtev_za_izvod.ZahtevZaIzvod  zahtev )*
     */
    public com.project.presek.Presek sendPresek(com.project.zahtev_za_izvod.ZahtevZaIzvod zahtev) throws SendPresekFault    { 
        LOG.info("Executing operation sendPresek");
        System.out.println(zahtev);
        if(!checkZahtev(zahtev)){
        	throw new SendPresekFault("Sent message of type ZahtevZaIzvod was not well formed.");
        }
        try {
    		if(!checkZahtev(zahtev)){
                throw new ReceiveNalogFault("Invoice validation failed. Reason: "+
                		PortHelper.checkNalogEx);
    		}
    		ResourceBundle b = ResourceBundle.getBundle ("resource.deploy"+PortHelper.current_bank.getId());
    		PortHelper.KEY_STORE_FILE_CB =  (String) b.getObject("firma1.file");
    		PortHelper.KEY_STORE_PASSWORD_CB =  (String) b.getObject("firma1.password");
            com.project.presek.Presek _return = PortHelper.current_bank.formirajPresek(zahtev);
            return _return;
        } catch (java.lang.Exception ex) {
            ex.printStackTrace();
            throw new SendPresekFault(ex.getMessage());
        }
        //throw new SendPresekFault("sendPresekFault...");
    }

	/* (non-Javadoc)
     * @see com.project.bankaws.BankaPort#receiveMT103(com.project.mt103.Mt103  mt103 )*
     */
    public com.project.common_types.Status receiveMT103(com.project.mt103.Mt103 mt103) throws ReceiveMT103Fault   { 
        try {
            LOG.info("Executing operation receiveMT103");
            if(!checkMt103(mt103)){
            	throw new ReceiveMT103Fault("Sent message of type Mt103 was not well formed.");
            }
            PortHelper.current_bank.obradiRTGSNalog(mt103);
			RESTUtil.objectToDB("Banka/00"+PortHelper.current_bank.getId()+"/MT103", mt103.getIDPoruke(), mt103);
            System.out.println(mt103);
            com.project.common_types.Status _return = new com.project.common_types.Status();
            _return.setStatusText("RTGS invoice recieved and proccessed.");
            return _return;
        } catch (java.lang.Exception ex) {
            ex.printStackTrace();
            throw new ReceiveMT103Fault(ex.getMessage());
        }
        //throw new ReceiveMT103Fault("receiveMT103fault...");
    }

	/* (non-Javadoc)
     * @see com.project.bankaws.BankaPort#receiveNalog(com.project.nalog_za_placanje.NalogZaPlacanje  nalog )*
     */
    public com.project.common_types.Status receiveNalog(NalogZaPlacanje nalog) throws ReceiveNalogFault    { 
        LOG.info("Executing operation receiveNalog...");
        //System.out.println(nalog);
        com.project.common_types.Status _return = new com.project.common_types.Status();
        try {
        	//proveriti validnost naloga
    		if(!checkNalog(nalog)){
                throw new ReceiveNalogFault("Invoice validation failed. Reason: "+
                		PortHelper.checkNalogEx);
    		}
    		RESTUtil.objectToDB("Banka/00"+PortHelper.current_bank.getId()+"/Nalozi", nalog.getPlacanje().getIDPoruke().toString(), nalog);
    		//provera da li je racun primaoca u istoj banci
    		String broj_rk_primaoca = nalog.getPlacanje().getUplata().getRacunPrimaoca().getBrojRacuna();
    		TBankarskiRacunKlijenta racun_primaoca = PortHelper.current_bank.getSpecificAccount(broj_rk_primaoca);
    		
    		if(racun_primaoca != null){
    			//ako jeste, prebaciti odmah pare
    			Transakcija transakcijaPrimalac = PortHelper.current_bank.generisiTransakcijuUplate(nalog);
    			String broj_rk_duznika = nalog.getPlacanje().getUplata().getRacunDuznika().getBrojRacuna();
    			TBankarskiRacunKlijenta racun_duznika = PortHelper.current_bank.getSpecificAccount(broj_rk_duznika);
    			if(racun_duznika != null){
    				BigDecimal iznos = nalog.getPlacanje().getUplata().getIznos();
    				/* Generisanje podataka o transakciji*/
					Transakcija transakcijaDuznik = PortHelper.current_bank.generisiTransakcijuIsplate(nalog);
					
    				if((racun_duznika.getRaspolozivaSredstva()-iznos.doubleValue())>=0){
    					//duznik ima dovoljno para, skidamo pare
    					transakcijaDuznik.setStanjePreTransakcije(new BigDecimal(racun_duznika.getStanje()));
    					racun_duznika.setStanje(racun_duznika.getStanje()-iznos.doubleValue());
    					racun_duznika.setRaspolozivaSredstva(racun_duznika.getRaspolozivaSredstva()-iznos.doubleValue());
    					transakcijaDuznik.setStanjePosleTransakcije(new BigDecimal(racun_duznika.getStanje()));
    					//dodajemo primaocu
    					transakcijaPrimalac.setStanjePreTransakcije(new BigDecimal(racun_primaoca.getStanje()));
    					racun_primaoca.setStanje(racun_primaoca.getStanje()+iznos.doubleValue());
    					racun_primaoca.setRaspolozivaSredstva(racun_primaoca.getRaspolozivaSredstva()+iznos.doubleValue());
    					transakcijaPrimalac.setStanjePosleTransakcije(new BigDecimal(racun_primaoca.getStanje()));
    					
    					Transakcije wrappedResults = new Transakcije();
    					wrappedResults = (Transakcije) RESTUtil.doUnmarshallTransactions("//Transakcije", "Banka/00"+PortHelper.current_bank.getId()+"/Racuni/"+racun_primaoca.getRacun().getId(), wrappedResults);
    					wrappedResults.getTransakcija().add(transakcijaPrimalac);
    					RESTUtil.objectToDB("Banka/00"+PortHelper.current_bank.getId()+"/Racuni/"+racun_primaoca.getRacun().getId(), "Transakcije", wrappedResults);
    					
    					Transakcije wrappedResults2 = new Transakcije();
    					wrappedResults2 = (Transakcije) RESTUtil.doUnmarshallTransactions("//Transakcije", "Banka/00"+PortHelper.current_bank.getId()+"/Racuni/"+racun_duznika.getRacun().getId(), wrappedResults2);
    					wrappedResults2.getTransakcija().add(transakcijaDuznik);
    					RESTUtil.objectToDB("Banka/00"+PortHelper.current_bank.getId()+"/Racuni/"+racun_duznika.getRacun().getId(), "Transakcije", wrappedResults2);
    					
    					Racuni rac1 = new Racuni();
    					//Spustamo izmenjena stanja na racunima u bazu
    					rac1 = (Racuni) RESTUtil.doUnmarshall("//Racuni", "Banka/00"+PortHelper.current_bank.getId(), rac1);
    					
    					//Ovde uraditi update stanja na racunima, pa baciti u bazu ponovo
    	    			for(TBankarskiRacunKlijenta k: rac1.getRacun()){
    	    				//Nasli smo koji je racun u pitanju
    	    				if(k.getRacun().getBrojRacuna().equals(racun_duznika.getRacun().getBrojRacuna())){
    	    					//skidamo mu novac
    	    					k.setRaspolozivaSredstva(racun_duznika.getRaspolozivaSredstva());
    	    					k.setStanje(racun_duznika.getStanje());
    	    				}else if(k.getRacun().getBrojRacuna().equals(racun_primaoca.getRacun().getBrojRacuna())){
    	    					//dodajemo mu novac
    	    					k.setRaspolozivaSredstva(racun_primaoca.getRaspolozivaSredstva());
    	    					k.setStanje(racun_primaoca.getStanje());
    	    				}
    	    			}
    	    			
    					//vracamo u bazu izmenjena raspoloziva sredstva
    					RESTUtil.doMarshall("Banka/00"+PortHelper.current_bank.getId()+"/Racuni", rac1);
    					
    					//Status da je poruka obradjena bez greske
    	    	    	_return.setStatusCode(1);
    	    	    	_return.setStatusText("Your payment order has been received and proccessed.");
    	    	    	return _return;
    				} else {
    					//no-money exception
    					throw new NoMoneyException();
    				}
    			} else {
    				//wrong-bank exception
    				throw new WrongBankException();
    			}
    		}
    		if(!nalog.isHitno() && (nalog.getPlacanje().getUplata().getIznos().compareTo(BigDecimal.valueOf(250000.0)) == -1)){
        		PortHelper.current_bank.addNalogZaClearing(nalog);
        	} else {
        		//RTGS
    			String broj_rk_duznika = nalog.getPlacanje().getUplata().getRacunDuznika().getBrojRacuna();
    			TBankarskiRacunKlijenta racun_duznika = PortHelper.current_bank.getSpecificAccount(broj_rk_duznika);
				Transakcija transakcijaDuznik = PortHelper.current_bank.generisiTransakcijuIsplate(nalog);
				transakcijaDuznik.setStanjePreTransakcije(new BigDecimal(racun_duznika.getStanje()));
				
        		Mt103 rtgsNalog = PortHelper.rtgsObrada.kreirajMT103(nalog);
				
        		//spustanje mt103 u bazu
        		RESTUtil.objectToDB("Banka/00"+PortHelper.current_bank.getId()+"/MT103", rtgsNalog.getIDPoruke().toString(), rtgsNalog);
        		//slanje MT103
        		URL wsdl = new URL("http://localhost:8080/projCB/services/CB?wsdl");
    	    	QName serviceName = new QName("http://www.project.com/CBws", "CBservice");
    	    	QName portName = new QName("http://www.project.com/CBws", "CBport");
    	    	
    	    	Service service = Service.create(wsdl, serviceName);
    	        CBport centralnaBanka = service.getPort(portName, CBport.class);
    	        try{
    	        	
    	        	///////////////////////// DEO ZA KLIJENTSKI HANDLER ///////////////////////////
    	        	/////                                                                    //////
    			          Binding binding = ((BindingProvider)centralnaBanka).getBinding();
    			          @SuppressWarnings("rawtypes")
    			          List<Handler> handlerList = binding.getHandlerChain();
    			          handlerList.clear();
    			          handlerList.add(new WSSignatureHandler());
    			          handlerList.add(new WSCryptoHandler());
    			          binding.setHandlerChain(handlerList);  
    	        	/////                                                                    //////
    			    ///////////////////////////////////////////////////////////////////////////////
    			      
    	        	Mt900RTGS rtgsResponse = centralnaBanka.receiveMT103CB(rtgsNalog);
    	        	 //Spustanje odgovora u bazu
            		RESTUtil.objectToDB("Banka/00"+PortHelper.current_bank.getId()+"/MT900rtgs", rtgsResponse.getIDPoruke().toString(), rtgsResponse);

    				transakcijaDuznik.setStanjePosleTransakcije(new BigDecimal(racun_duznika.getStanje()));
            		Transakcije wrappedResults = new Transakcije();
    				wrappedResults = (Transakcije) RESTUtil.doUnmarshallTransactions("//Transakcije", "Banka/00"+PortHelper.current_bank.getId()+"/Racuni/"+racun_duznika.getRacun().getId(), wrappedResults);
    				wrappedResults.getTransakcija().add(transakcijaDuznik);
    				RESTUtil.objectToDB("Banka/00"+PortHelper.current_bank.getId()+"/Racuni/"+racun_duznika.getRacun().getId(), "Transakcije", wrappedResults);
    				
            		//Status klijentu da je poruka obradjena bez greske
        	    	_return.setStatusCode(1);
        	    	_return.setStatusText("Your payment order has been received and sent to processing.");
    	        } catch(com.project.util.ReceiveMT103Fault e){
					racun_duznika.setRaspolozivaSredstva(racun_duznika.getRaspolozivaSredstva()+
							nalog.getPlacanje().getUplata().getIznos().doubleValue());
					//Update stanja racuna u bazi
					Racuni rac1 = new Racuni();
	    			rac1 = (Racuni) RESTUtil.doUnmarshall("//Racuni", "Banka/00"+PortHelper.current_bank.getId(), rac1);
	    			//Ovde uraditi update stanja na racunima, pa baciti u bazu ponovo
	    			for(TBankarskiRacunKlijenta k: rac1.getRacun()){
	    				//Nasli smo koji je racun u pitanju
	    				if(k.getRacun().getBrojRacuna().equals(racun_duznika.getRacun().getBrojRacuna())){
	    					//dodajemo mu novac
	    					k.setRaspolozivaSredstva(racun_duznika.getRaspolozivaSredstva());
	    					break;
	    				}
	    			}
	    			//vracamo u bazu izmenjena raspoloziva sredstva
	    			RESTUtil.doMarshall("Banka/00"+PortHelper.current_bank.getId()+"Racuni", rac1);
	    			throw new ReceiveNalogFault("Payment order hasn't been processed by the central bank. Reason: "+
	    					e.getMessage());
    	        }
        	}
            return _return;
        } catch (java.lang.Exception ex) {
            ex.printStackTrace();
            throw new ReceiveNalogFault(ex.getMessage());
        }
    }
    
    public boolean checkNalog(NalogZaPlacanje nalog) throws Exception {
    	try {
    		//Validacija po semi
    		//Upisujemo u privremeni fajl, kako bi mogli da radimo validaciju nad xml fajlom, a ne java objektom
	    	File schemaFile = new File(PortHelper.SCHEMA_PATH+"nalog_za_placanje.xsd");
			JAXBContext context1 = JAXBContext.newInstance(nalog.getClass());
			Marshaller marshaller1 = context1.createMarshaller();
			marshaller1.setProperty(Marshaller.JAXB_FORMATTED_OUTPUT, Boolean.TRUE);
            OutputStream os = new FileOutputStream(PortHelper.TEST_FILE );
            marshaller1.marshal( nalog, os );
			IOUtils.closeQuietly(os);
				
				
	    	Source xmlFile = new StreamSource(new File(PortHelper.TEST_FILE));
	    	SchemaFactory schemaFactory = SchemaFactory.newInstance(XMLConstants.W3C_XML_SCHEMA_NS_URI);
	    	Schema schema = schemaFactory.newSchema(schemaFile);
	    	Validator validator = schema.newValidator();
	    	validator.validate(xmlFile);
	    	
	    	//Provera da li su sva polja ispunjena
	    	boolean filled = true;
	    	if(nalog.getDatumValute() == null){
	    		filled = false;
	    	}
	    	if(nalog.getPlacanje().getIDPoruke() == null){
	    		filled = false;
	    	}
	    	if(nalog.getPlacanje().getSifraValute() == null){
	    		filled = false;
	    	}
	    	if(nalog.getPlacanje().getUplata().getDatumNaloga() == null){
	    		filled = false;
	    	}
	    	if(nalog.getPlacanje().getUplata().getIznos() == null || nalog.getPlacanje().getUplata().getIznos().equals("")){
	    		filled = false;
	    	}
	    	if(nalog.getPlacanje().getUplata().getPozivNaBrojOdobrenja() == null || 
	    			nalog.getPlacanje().getUplata().getPozivNaBrojOdobrenja().equals("")){
	    		filled = false;
	    	}
	    	if(nalog.getPlacanje().getUplata().getPozivNaBrojZaduzenja()== null || 
	    			nalog.getPlacanje().getUplata().getPozivNaBrojZaduzenja().equals("")){
	    		filled = false;
	    	}
	    	if(nalog.getPlacanje().getUplata().getSvrhaPlacanja() == null || 
	    			nalog.getPlacanje().getUplata().getSvrhaPlacanja().equals("")){
	    		filled = false;
	    	}
	    	if(nalog.getPlacanje().getUplata().getRacunDuznika().getBrojRacuna() == null || 
	    			nalog.getPlacanje().getUplata().getRacunDuznika().getBrojRacuna().equals("")){
	    		filled = false;
	    	}
	    	if(nalog.getPlacanje().getUplata().getRacunPrimaoca().getBrojRacuna() == null || 
	    			nalog.getPlacanje().getUplata().getRacunPrimaoca().getBrojRacuna().equals("")){
	    		filled = false;
	    	}
	    	if(nalog.getPlacanje().getUplata().getRacunDuznika().getVlasnik() == null || 
	    			nalog.getPlacanje().getUplata().getRacunDuznika().getVlasnik().equals("")){
	    		filled = false;
	    	}
	    	if(nalog.getPlacanje().getUplata().getRacunPrimaoca().getVlasnik() == null || 
	    			nalog.getPlacanje().getUplata().getRacunPrimaoca().getVlasnik().equals("")){
	    		filled = false;
	    	}
	    	if(nalog.getPlacanje().getUplata().getRacunDuznika().getId() == null){
	    		filled = false;
	    	}
	    	if(nalog.getPlacanje().getUplata().getRacunPrimaoca().getId() == null){
	    		filled = false;
	    	}
	    	
	    	if(!filled){
	    		PortHelper.checkNalogEx = "One of the fields was empty.";
		    	System.out.println(PortHelper.checkNalogEx);
		    	FileOutputStream writer = new FileOutputStream(PortHelper.TEST_FILE);
		    	writer.write((new String()).getBytes());
		    	writer.close();
				return false;
			}
	    	
	    	//Provera da li ta druga banka postoji
	    	String cbOznakaBankePoverioca = nalog.getPlacanje().getUplata().getRacunPrimaoca().getBrojRacuna().substring(0, 3);
	    	RacuniBanaka rac = new RacuniBanaka();
			rac = (RacuniBanaka) RESTUtil.doUnmarshall("//racuni_banaka", "Banke/Podaci", rac);
			
			
			boolean found = false;
			for(KodBanke k: rac.getKodBanke()){
				if(k.getId().equals(cbOznakaBankePoverioca)){
					found = true;
					break;
				}
			}
			if(!found){
				PortHelper.checkNalogEx = "Recipient's bank does not exist.";
		    	System.out.println(PortHelper.checkNalogEx);
		    	FileOutputStream writer = new FileOutputStream(PortHelper.TEST_FILE);
		    	writer.write((new String()).getBytes());
		    	writer.close();
				return false;
			}

	    	FileOutputStream writer = new FileOutputStream(PortHelper.TEST_FILE);
	    	writer.write((new String()).getBytes());
	    	writer.close();
	    	PortHelper.checkNalogEx = "";
	    	return true;
    	} catch (Exception e) {
	    	System.out.println("Xml is NOT valid");
	    	System.out.println("Reason: " + e.getLocalizedMessage());
	    	FileOutputStream writer = new FileOutputStream(PortHelper.TEST_FILE);
	    	writer.write((new String()).getBytes());
	    	writer.close();
	    	return false;
    	}
    }
    
    private boolean checkMt910(Mt910 mt910) {
    	try {
    		//Validacija po semi
    		//Upisujemo u privremeni fajl, kako bi mogli da radimo validaciju nad xml fajlom, a ne java objektom
	    	File schemaFile = new File(PortHelper.SCHEMA_PATH+"mt910.xsd");
			JAXBContext context1 = JAXBContext.newInstance(mt910.getClass());
			Marshaller marshaller1 = context1.createMarshaller();
			marshaller1.setProperty(Marshaller.JAXB_FORMATTED_OUTPUT, Boolean.TRUE);
            OutputStream os = new FileOutputStream(PortHelper.TEST_FILE );
            marshaller1.marshal( mt910, os );
			IOUtils.closeQuietly(os);
				
	    	Source xmlFile = new StreamSource(new File(PortHelper.TEST_FILE));
	    	SchemaFactory schemaFactory = SchemaFactory.newInstance(XMLConstants.W3C_XML_SCHEMA_NS_URI);
	    	Schema schema = schemaFactory.newSchema(schemaFile);
	    	Validator validator = schema.newValidator();
	    	validator.validate(xmlFile);
	    	
	    	//Provera da li su sva polja ispunjena
	    	boolean filled = true;
	    	if(mt910.getIDPoruke() == null || mt910.getIDPoruke().equals("")){
	    		filled = false;
	    	}
	    	if(mt910.getPodaciOOdobrenju() == null){
	    		filled = false;
	    	}
	    	if(mt910.getPodaciOOdobrenju().getBankaPoverioca() == null){
	    		filled = false;
	    	}
	    	if(mt910.getPodaciOOdobrenju().getDatumValute() == null){
	    		filled = false;
	    	}
	    	if(mt910.getPodaciOOdobrenju().getIDPorukeNaloga() == null || mt910.getPodaciOOdobrenju().getIDPorukeNaloga().equals("")){
	    		filled = false;
	    	}
	    	if(mt910.getPodaciOOdobrenju().getIznos() == null || mt910.getPodaciOOdobrenju().getIznos().equals("")){
	    		filled = false;
	    	}
	    	if(mt910.getPodaciOOdobrenju().getSifraValute() == null || mt910.getPodaciOOdobrenju().getSifraValute().equals("")){
	    		filled = false;
	    	}
	    	
	    	if(!filled){
	    		PortHelper.checkNalogEx = "One of the fields was empty.";
		    	System.out.println(PortHelper.checkNalogEx);
		    	FileOutputStream writer = new FileOutputStream(PortHelper.TEST_FILE);
		    	writer.write((new String()).getBytes());
		    	writer.close();
				return false;
			}
	    	FileOutputStream writer = new FileOutputStream(PortHelper.TEST_FILE);
	    	writer.write((new String()).getBytes());
	    	writer.close();
	    	PortHelper.checkNalogEx = "";
	    	return true;
    	} catch (Exception e) {
	    	System.out.println("Xml is NOT valid");
	    	System.out.println("Reason: " + e.getLocalizedMessage());
	    	FileOutputStream writer;
			try {
				writer = new FileOutputStream(PortHelper.TEST_FILE);
				writer.write((new String()).getBytes());
				writer.close();
			} catch (Exception e1) {
				e1.printStackTrace();
			}
	    	return false;
    	}
	}
    
    private boolean checkMt103(Mt103 mt103) {
    	try {
    		//Validacija po semi
    		//Upisujemo u privremeni fajl, kako bi mogli da radimo validaciju nad xml fajlom, a ne java objektom
	    	File schemaFile = new File(PortHelper.SCHEMA_PATH+"mt103.xsd");
			JAXBContext context1 = JAXBContext.newInstance(mt103.getClass());
			Marshaller marshaller1 = context1.createMarshaller();
			marshaller1.setProperty(Marshaller.JAXB_FORMATTED_OUTPUT, Boolean.TRUE);
            OutputStream os = new FileOutputStream(PortHelper.TEST_FILE );
            marshaller1.marshal( mt103, os );
			IOUtils.closeQuietly(os);
				
				
	    	Source xmlFile = new StreamSource(new File(PortHelper.TEST_FILE));
	    	SchemaFactory schemaFactory = SchemaFactory.newInstance(XMLConstants.W3C_XML_SCHEMA_NS_URI);
	    	Schema schema = schemaFactory.newSchema(schemaFile);
	    	Validator validator = schema.newValidator();
	    	validator.validate(xmlFile);
	    	
	    	

	    	FileOutputStream writer = new FileOutputStream(PortHelper.TEST_FILE);
	    	writer.write((new String()).getBytes());
	    	writer.close();
	    	PortHelper.checkNalogEx = "";
	    	return true;
    	} catch (Exception e) {
	    	System.out.println("Xml is NOT valid");
	    	System.out.println("Reason: " + e.getLocalizedMessage());
	    	FileOutputStream writer;
			try {
				writer = new FileOutputStream(PortHelper.TEST_FILE);
		    	writer.write((new String()).getBytes());
		    	writer.close();
			} catch (Exception e1) {
				e1.printStackTrace();
			}
	    	return false;
    	}
	}

    private boolean checkMt102(Mt102 mt102) {
    	try {
    		//Validacija po semi
    		//Upisujemo u privremeni fajl, kako bi mogli da radimo validaciju nad xml fajlom, a ne java objektom
	    	File schemaFile = new File(PortHelper.SCHEMA_PATH+"mt102.xsd");
			JAXBContext context1 = JAXBContext.newInstance(mt102.getClass());
			Marshaller marshaller1 = context1.createMarshaller();
			marshaller1.setProperty(Marshaller.JAXB_FORMATTED_OUTPUT, Boolean.TRUE);
            OutputStream os = new FileOutputStream(PortHelper.TEST_FILE );
            marshaller1.marshal( mt102, os );
			IOUtils.closeQuietly(os);
				
				
	    	Source xmlFile = new StreamSource(new File(PortHelper.TEST_FILE));
	    	SchemaFactory schemaFactory = SchemaFactory.newInstance(XMLConstants.W3C_XML_SCHEMA_NS_URI);
	    	Schema schema = schemaFactory.newSchema(schemaFile);
	    	Validator validator = schema.newValidator();
	    	validator.validate(xmlFile);
	    	
	    	//Provera da li su sva polja ispunjena
	    	boolean filled = true;
	    	if(mt102.getDatumValute() == null){
	    		filled = false;
	    	}
	    	if(mt102.getIDPoruke() == null || mt102.getIDPoruke().equals("")){
	    		filled = false;
	    	}
	    	if(mt102.getSifraValute() == null || mt102.getSifraValute().equals("")){
	    		filled = false;
	    	}
	    	if(mt102.getBankaDuznika() == null){
	    		filled = false;
	    	}
	    	if(mt102.getBankaPoverioca() == null){
	    		filled = false;
	    	}
	    	if(mt102.getDatum() == null){
	    		filled = false;
	    	}
	    	if(mt102.getIDPoruke() == null || mt102.getIDPoruke().equals("")){
	    		filled = false;
	    	}
	    	if(mt102.getPlacanje() == null){
	    		filled = false;
	    	}
	    	if(mt102.getSifraValute() == null || mt102.getSifraValute().equals("")){
	    		filled = false;
	    	}
	    	if(mt102.getUkupanIznos() == null){
	    		filled = false;
	    	}
	    	if(mt102.getBankaDuznika().getBrojRacunaBanke() == null || mt102.getBankaDuznika().getBrojRacunaBanke().equals("")){
	    		filled = false;
	    	}
	    	if(mt102.getBankaDuznika().getId() == null){
	    		filled = false;
	    	}
	    	if(mt102.getBankaDuznika().getNazivBanke() == null || mt102.getBankaDuznika().getNazivBanke().equals("")){
	    		filled = false;
	    	}
	    	if(mt102.getBankaDuznika().getSWIFTKod() == null || mt102.getBankaDuznika().getSWIFTKod().equals("")){
	    		filled = false;
	    	}
	    	if(mt102.getBankaPoverioca().getBrojRacunaBanke() == null || mt102.getBankaPoverioca().getBrojRacunaBanke().equals("")){
	    		filled = false;
	    	}
	    	if(mt102.getBankaPoverioca().getId() == null){
	    		filled = false;
	    	}
	    	if(mt102.getBankaPoverioca().getNazivBanke() == null || mt102.getBankaPoverioca().getNazivBanke().equals("")){
	    		filled = false;
	    	}
	    	if(mt102.getBankaPoverioca().getSWIFTKod() == null || mt102.getBankaPoverioca().getSWIFTKod().equals("")){
	    		filled = false;
	    	}
	    	
	    	if(!filled){
	    		PortHelper.checkNalogEx = "One of the fields was empty.";
		    	System.out.println(PortHelper.checkNalogEx);
		    	FileOutputStream writer = new FileOutputStream(PortHelper.TEST_FILE);
		    	writer.write((new String()).getBytes());
		    	writer.close();
				return false;
			}

	    	FileOutputStream writer = new FileOutputStream(PortHelper.TEST_FILE);
	    	writer.write((new String()).getBytes());
	    	writer.close();
	    	PortHelper.checkNalogEx = "";
	    	return true;
    	} catch (Exception e) {
	    	System.out.println("Xml is NOT valid");
	    	System.out.println("Reason: " + e.getLocalizedMessage());
	    	FileOutputStream writer;
			try {
				writer = new FileOutputStream(PortHelper.TEST_FILE);
				writer.write((new String()).getBytes());
				writer.close();
			} catch (Exception e1) {
				e1.printStackTrace();
			}
	    	return false;
    	}
	}

    private boolean checkZahtev(ZahtevZaIzvod zahtev) {
    	try {
    		//Validacija po semi
    		//Upisujemo u privremeni fajl, kako bi mogli da radimo validaciju nad xml fajlom, a ne java objektom
	    	File schemaFile = new File(PortHelper.SCHEMA_PATH+"zahtev_za_izvod.xsd");
			JAXBContext context1 = JAXBContext.newInstance(zahtev.getClass());
			Marshaller marshaller1 = context1.createMarshaller();
			marshaller1.setProperty(Marshaller.JAXB_FORMATTED_OUTPUT, Boolean.TRUE);
            OutputStream os = new FileOutputStream(PortHelper.TEST_FILE );
            marshaller1.marshal( zahtev, os );
			IOUtils.closeQuietly(os);
				
				
	    	Source xmlFile = new StreamSource(new File(PortHelper.TEST_FILE));
	    	SchemaFactory schemaFactory = SchemaFactory.newInstance(XMLConstants.W3C_XML_SCHEMA_NS_URI);
	    	Schema schema = schemaFactory.newSchema(schemaFile);
	    	Validator validator = schema.newValidator();
	    	validator.validate(xmlFile);
	    	
	    	//Provera da li su sva polja ispunjena
	    	boolean filled = true;
	    	if(zahtev.getBrojRacuna() == null ||zahtev.getBrojRacuna().equals("")){
	    		filled = false;
	    	}
	    	if(zahtev.getDatum() == null){
	    		filled = false;
	    	}
	    	
	    	if(!filled){
	    		PortHelper.checkNalogEx = "One of the fields was empty.";
		    	System.out.println(PortHelper.checkNalogEx);
		    	FileOutputStream writer = new FileOutputStream(PortHelper.TEST_FILE);
		    	writer.write((new String()).getBytes());
		    	writer.close();
				return false;
			}
	    	
	    	boolean found = false;
	    	//Provera da li taj racun postoji
	    	if (PortHelper.current_bank.getSpecificAccount(zahtev.getBrojRacuna()) != null)
	    		found = true;
			
			if(!found){
				PortHelper.checkNalogEx = "Client's account does not exist.";
		    	System.out.println(PortHelper.checkNalogEx);
		    	FileOutputStream writer = new FileOutputStream(PortHelper.TEST_FILE);
		    	writer.write((new String()).getBytes());
		    	writer.close();
				return false;
			}

	    	FileOutputStream writer = new FileOutputStream(PortHelper.TEST_FILE);
	    	writer.write((new String()).getBytes());
	    	writer.close();
	    	PortHelper.checkNalogEx = "";
	    	return true;
    	} catch (Exception e) {
	    	System.out.println("Xml is NOT valid");
	    	System.out.println("Reason: " + e.getLocalizedMessage());
	    	FileOutputStream writer;
			try {
				writer = new FileOutputStream(PortHelper.TEST_FILE);
				writer.write((new String()).getBytes());
				writer.close();
			} catch (Exception e1) {
				e1.printStackTrace();
			}
	    	return false;
    	}
	}
    
    public static void main(String[] args) {
    	
    	//Ako kaze da nema dovoljno para na racunu, pokreni RESTUtil main metodu da ucita pare klijentima.
    	
    	BankaPortImpl b = new BankaPortImpl();
    	
    	NalogZaPlacanje novi = new NalogZaPlacanje();
    	try {
			novi.setDatumValute(Util.getXMLGregorianCalendarNow());
		} catch (DatatypeConfigurationException e1) {
			// TODO Auto-generated catch block
			e1.printStackTrace();
		}
    	novi.setHitno(true);
    	Placanje p = new Placanje();
    	p.setIDPoruke("5");
    	p.setSifraValute("RSD");
    	Uplata u = new Uplata();
    	try {
			u.setDatumNaloga(Util.getXMLGregorianCalendarNow());
		} catch (DatatypeConfigurationException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
    	u.setIznos(BigDecimal.valueOf(350000.0));
    	u.setModelOdobrenja(12);
    	u.setModelZaduzenja(12);
    	u.setPozivNaBrojOdobrenja("12335678912345678912");
    	u.setPozivNaBrojZaduzenja("12335678912345678912");
    	TRacunKlijenta t1 = new TRacunKlijenta();
    	t1.setBrojRacuna("001-0000000000001-00");
    	t1.setId(Long.parseLong("1"));
    	t1.setVlasnik("Pera Peric");
    	u.setRacunDuznika(t1);
    	TRacunKlijenta t2 = new TRacunKlijenta();
    	t2.setBrojRacuna("002-0000000000001-00");
    	t2.setId(Long.parseLong("1"));
    	t2.setVlasnik("Mara Maric");
    	u.setRacunPrimaoca(t2);
    	u.setSvrhaPlacanja("Eto 'nako");
    	p.setUplata(u);
    	novi.setPlacanje(p);
		try {
			//s = b.receiveNalog(novi);
	    	//System.out.println(s.getStatusText());
			//System.out.println(b.checkNalog(novi));
		      
			b.receiveNalog(novi);
			
			System.out.println("Done.");
		} catch (Exception e) {
			e.printStackTrace();
		}
    }

}
